---
- name: create environment
  become: vagrant
  block:
  - name: set ~/.ssh/config defaults
    template:
      src: home/vagrant/.ssh/config
      dest: ~/.ssh/config
  - name: create user service dir
    file:
      name: ~/.config/systemd/user
      state: directory
  - name: render ssh-agent user service
    template:
      src: home/vagrant/.config/systemd/user/ssh-agent.service
      dest: ~/.config/systemd/user/ssh-agent.service
  - name: enable user service for ssh-agent
    systemd:
      name: ssh-agent
      scope: user
      state: started
      enabled: yes
      daemon-reload: yes

  - name: extend PATH
    lineinfile:
      path: ~/.bashrc
      line: 'export PATH=$PATH:/vagrant/bin'
  - name: SSH_AUTH_SOCK shell variable
    lineinfile:
      path: ~/.bashrc
      line: 'export SSH_AUTH_SOCK="$XDG_RUNTIME_DIR/ssh-agent.socket"'
  - name: clone repos
    git:
      repo: "{{item.src}}"
      dest: "{{item.dest}}"
    with_items: "{{ clone_git }}"
    when: clone_git


  - name: install pip deps
    pip:
      name: "{{ pip2_deps }}"
      executable: pip2

  - name: create a vaultified direnv .envrc for vagrant
    notify:
      - direnv allow
    template:
      src: home/vagrant/.envrc
      dest: ~/.envrc
  - name: enable direnv hooks
    lineinfile:
      path: ~/.bashrc
      regexp: '^eval "$(direnv hook bash)"$'
      line: 'eval "$(direnv hook bash)"'

  - name: copy .aliases
    copy:
      src: .aliases
      dest: ~/.aliases
  - name: hook aliases file
    lineinfile:
      path: ~/.bashrc
      regexp: '^. ~/.aliases$'
      line: '. ~/.aliases'
